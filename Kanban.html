<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kanban Board</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#1a1a2e;color:#e8eaed;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

  #toolbar{display:flex;align-items:center;gap:12px;padding:10px 16px;background:#16213e;border-bottom:1px solid #0f3460;flex-shrink:0;}
  #toolbar h2{font-size:15px;color:#4fc3f7;margin-right:auto;}
  .tb-btn{background:#0f3460;border:none;color:#e8eaed;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;}
  .tb-btn:hover{background:#1a73e8;}
  input[type="text"]{background:#0f3460;border:1px solid #1a73e8;color:#e8eaed;padding:5px 10px;border-radius:6px;font-size:12px;width:180px;}
  select{background:#0f3460;border:1px solid #1a73e8;color:#e8eaed;padding:5px 10px;border-radius:6px;font-size:12px;}

  #board{flex:1;display:flex;gap:16px;padding:16px;overflow-x:auto;overflow-y:hidden;}

  .column{flex-shrink:0;width:280px;background:#16213e;border-radius:12px;display:flex;flex-direction:column;border-top:3px solid;}
  .column-header{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #0f3460;}
  .column-title{font-weight:700;font-size:13px;display:flex;align-items:center;gap:8px;}
  .col-count{background:rgba(255,255,255,.12);border-radius:12px;padding:2px 8px;font-size:11px;}
  .column-body{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:10px;}
  .add-card-btn{display:flex;align-items:center;gap:6px;padding:8px;border-radius:6px;border:1px dashed #0f3460;cursor:pointer;font-size:12px;color:#9aa0a6;margin-top:4px;}
  .add-card-btn:hover{background:#0f3460;color:#e8eaed;}

  /* Card */
  .card{background:#0d1b2a;border-radius:10px;padding:14px;cursor:grab;border:1px solid #0f3460;transition:all .2s;position:relative;}
  .card:hover{border-color:#1a73e8;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.4);}
  .card.dragging{opacity:.5;transform:rotate(2deg);}
  .card.drag-over{border-color:#4fc3f7;background:#0f2033;}
  .card-title{font-size:13px;font-weight:600;margin-bottom:10px;line-height:1.4;}
  .card-meta{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;}
  .card-assignee{display:flex;align-items:center;gap:6px;font-size:11px;color:#9aa0a6;}
  .avatar{width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,#1a73e8,#4fc3f7);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;}
  .card-labels{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;}
  .label-tag{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:600;}
  .card-due{font-size:10px;color:#9aa0a6;display:flex;align-items:center;gap:4px;}
  .card-due.overdue{color:#ef5350;}
  .priority-dot{width:8px;height:8px;border-radius:50%;}
  .card-id{font-size:10px;color:#555;position:absolute;top:8px;right:10px;}
  .card-progress{height:3px;background:#0f3460;border-radius:2px;margin-top:10px;}
  .card-progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#1a73e8,#4fc3f7);}

  /* Priority colours */
  .p-critical{background:#ef5350;}.p-high{background:#ffa726;}.p-medium{background:#4fc3f7;}.p-low{background:#66bb6a;}

  /* Add card inline form */
  .new-card-form{background:#0d1b2a;border-radius:8px;padding:10px;border:1px solid #1a73e8;}
  .new-card-form textarea{width:100%;background:transparent;border:none;color:#e8eaed;font-size:13px;resize:none;outline:none;font-family:inherit;}
  .new-card-form-actions{display:flex;gap:8px;margin-top:8px;}
  .btn-sm{padding:4px 12px;border-radius:4px;border:none;cursor:pointer;font-size:12px;}
  .btn-primary{background:#1a73e8;color:#fff;}.btn-cancel{background:#0f3460;color:#9aa0a6;}

  .col-backlog{border-top-color:#78909c;}
  .col-todo{border-top-color:#9aa0a6;}
  .col-inprogress{border-top-color:#4fc3f7;}
  .col-review{border-top-color:#ffa726;}
  .col-done{border-top-color:#66bb6a;}
</style>
</head>
<body>

<div id="toolbar">
  <h2>ğŸƒ Kanban Board</h2>
  <input type="text" id="search" placeholder="ğŸ” Search cardsâ€¦" oninput="applyFilters()">
  <select id="filterAssignee" onchange="applyFilters()">
    <option value="">All Assignees</option>
  </select>
  <select id="filterPriority" onchange="applyFilters()">
    <option value="">All Priorities</option>
    <option>Critical</option><option>High</option><option>Medium</option><option>Low</option>
  </select>
  <button class="tb-btn" onclick="addColumn()">+ Column</button>
  <button class="tb-btn" onclick="google.script.host.close()">âœ• Close</button>
</div>
<div id="board"></div>

<script>
var allTasks = [];
var columns = ['Backlog','To Do','In Progress','In Review','Done'];
var colClasses = {
  'Backlog':'col-backlog','To Do':'col-todo','In Progress':'col-inprogress',
  'In Review':'col-review','Done':'col-done'
};
var PRIORITY_COLOR = {Critical:'p-critical',High:'p-high',Medium:'p-medium',Low:'p-low'};

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData() {
  google.script.run
    .withSuccessHandler(function(rows) {
      allTasks = rows.map(function(r) {
        return {
          id:       r._rowIndex,
          title:    r['Task Name'] || r[Object.keys(r)[3]] || '(unnamed)',
          status:   r['Status'] || 'To Do',
          assignee: r['Assigned To'] || '',
          priority: r['Priority'] || 'Medium',
          due:      r['Due Date'] || r['End Date'] || null,
          labels:   r['Labels'] ? String(r['Labels']).split(',').map(function(l){return l.trim();}) : [],
          notes:    r['Notes'] || '',
          pct:      parseInt(r['% Complete'] || 0) || 0
        };
      });

      // Detect columns from Status options
      var statusValues = [...new Set(allTasks.map(function(t){return t.status;}).filter(Boolean))];
      columns.forEach(function(c) { if (!statusValues.includes(c)) {}});
      statusValues.forEach(function(s) { if (!columns.includes(s)) columns.push(s); });

      // Populate assignee filter
      var assignees = [...new Set(allTasks.map(function(t){return t.assignee;}).filter(Boolean))];
      var sel = document.getElementById('filterAssignee');
      assignees.forEach(function(a) {
        var opt = document.createElement('option');
        opt.value = a; opt.text = a; sel.appendChild(opt);
      });
      renderBoard(allTasks);
    })
    .getRowTree(SpreadsheetApp.getActiveSheet());
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard(tasks) {
  var board = document.getElementById('board');
  board.innerHTML = '';
  columns.forEach(function(col) {
    var colTasks = tasks.filter(function(t){ return t.status === col; });
    board.appendChild(createColumn(col, colTasks));
  });
  initDragDrop();
}

function createColumn(title, tasks) {
  var div = document.createElement('div');
  div.className = 'column ' + (colClasses[title] || 'col-inprogress');
  div.dataset.status = title;

  div.innerHTML =
    '<div class="column-header">' +
    '<div class="column-title"><span>' + statusEmoji(title) + ' ' + title + '</span>' +
    '<span class="col-count">' + tasks.length + '</span></div></div>' +
    '<div class="column-body" id="col-' + slugify(title) + '">' +
    tasks.map(createCardHTML).join('') +
    '<div class="add-card-btn" onclick="startAddCard(\'' + title + '\')">+ Add card</div>' +
    '</div>';
  return div;
}

function createCardHTML(t) {
  var today = new Date(); today.setHours(0,0,0,0);
  var due = t.due ? new Date(t.due) : null;
  var isOverdue = due && due < today && t.status !== 'Done';
  var initials = t.assignee ? t.assignee.split(' ').map(function(w){return w[0];}).slice(0,2).join('') : '?';
  var pColor = PRIORITY_COLOR[t.priority] || 'p-medium';

  var labelsHtml = t.labels.filter(Boolean).slice(0,3).map(function(l, i) {
    var labelColors = ['#1a3a5c','#2a4a1c','#4a2a1c'];
    return '<span class="label-tag" style="background:' + labelColors[i%3] + ';color:#ccc">' + escHtml(l) + '</span>';
  }).join('');

  return '<div class="card" draggable="true" data-id="' + t.id + '" data-status="' + escHtml(t.status) + '">' +
    '<span class="card-id">#' + t.id + '</span>' +
    (labelsHtml ? '<div class="card-labels">' + labelsHtml + '</div>' : '') +
    '<div class="card-title">' + escHtml(t.title) + '</div>' +
    '<div class="card-meta">' +
    '<div class="card-assignee"><div class="avatar">' + escHtml(initials) + '</div>' +
    '<span>' + escHtml(t.assignee || 'â€”') + '</span></div>' +
    '<span class="priority-dot ' + pColor + '" title="' + t.priority + '"></span>' +
    '</div>' +
    (due ? '<div class="card-due' + (isOverdue ? ' overdue' : '') + '">' +
      (isOverdue ? 'âš ï¸ ' : 'ğŸ“… ') + due.toLocaleDateString('en-SG',{day:'2-digit',month:'short'}) + '</div>' : '') +
    (t.pct > 0 ? '<div class="card-progress"><div class="card-progress-fill" style="width:' + t.pct + '%"></div></div>' : '') +
    '</div>';
}

// â”€â”€ Add card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAddCard(status) {
  var colId = 'col-' + slugify(status);
  var body = document.getElementById(colId);
  if (!body) return;
  var form = document.createElement('div');
  form.className = 'new-card-form';
  form.innerHTML =
    '<textarea id="new-card-text" rows="3" placeholder="Enter task nameâ€¦" autofocus></textarea>' +
    '<div class="new-card-form-actions">' +
    '<button class="btn-sm btn-primary" onclick="submitCard(\'' + status + '\')">Add</button>' +
    '<button class="btn-sm btn-cancel" onclick="this.parentElement.parentElement.remove()">Cancel</button>' +
    '</div>';
  // Insert before the Add button
  var addBtn = body.querySelector('.add-card-btn');
  body.insertBefore(form, addBtn);
  body.querySelector('#new-card-text').focus();
}

function submitCard(status) {
  var ta = document.getElementById('new-card-text');
  var text = ta ? ta.value.trim() : '';
  if (!text) return;
  google.script.run
    .withSuccessHandler(function() { loadData(); })
    .addTaskToSheet(text, status);
}

// â”€â”€ Drag and drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initDragDrop() {
  document.querySelectorAll('.card').forEach(function(card) {
    card.addEventListener('dragstart', function(e) {
      card.classList.add('dragging');
      e.dataTransfer.setData('text/plain', card.dataset.id + '|' + card.dataset.status);
    });
    card.addEventListener('dragend', function() { card.classList.remove('dragging'); });
  });

  document.querySelectorAll('.column-body').forEach(function(col) {
    col.addEventListener('dragover', function(e) {
      e.preventDefault();
      col.classList.add('drag-over');
    });
    col.addEventListener('dragleave', function() { col.classList.remove('drag-over'); });
    col.addEventListener('drop', function(e) {
      e.preventDefault();
      col.classList.remove('drag-over');
      var data = e.dataTransfer.getData('text/plain').split('|');
      var rowId = parseInt(data[0]);
      var newStatus = col.closest('.column').dataset.status;
      if (newStatus) {
        google.script.run
          .withSuccessHandler(loadData)
          .updateTaskStatus(rowId, newStatus);
      }
    });
  });
}

// â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  var q        = document.getElementById('search').value.toLowerCase();
  var assignee = document.getElementById('filterAssignee').value;
  var priority = document.getElementById('filterPriority').value;
  var filtered = allTasks.filter(function(t) {
    return (!q || t.title.toLowerCase().includes(q) || (t.notes||'').toLowerCase().includes(q)) &&
           (!assignee || t.assignee === assignee) &&
           (!priority || t.priority === priority);
  });
  renderBoard(filtered);
}

function addColumn() {
  var name = prompt('Column name:');
  if (!name) return;
  columns.push(name);
  renderBoard(allTasks);
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusEmoji(s) {
  var m = {'Backlog':'ğŸ“¦','To Do':'ğŸ“‹','In Progress':'ğŸ”„','In Review':'ğŸ‘€','Done':'âœ…','Blocked':'ğŸš¨','Cancelled':'âŒ'};
  return m[s] || 'â€¢';
}
function slugify(s) { return s.replace(/\s+/g,'-').replace(/[^a-zA-Z0-9-]/g,'').toLowerCase(); }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
